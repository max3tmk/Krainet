#!/bin/sh

if [ -z "$JAVA_HOME" ]; then
  echo "Error: JAVA_HOME is not set."
  exit 1
fi

if [ -z "$JAVACMD" ]; then
  if [ -x "$JAVA_HOME/bin/java" ]; then
    JAVACMD="$JAVA_HOME/bin/java"
  else
    JAVACMD="java"
  fi
fi

if [ ! -x "$JAVACMD" ]; then
  echo "Error: JAVA_HOME is not defined correctly or java is not executable."
  exit 1
fi

find_maven_basedir() {
  dir="$1"
  while [ "$dir" != "/" ]; do
    if [ -d "$dir/.mvn" ]; then
      echo "$dir"
      return
    fi
    dir=$(dirname "$dir")
  done
  echo ""
}

BASE_DIR=$(find_maven_basedir "$(pwd)")
if [ -z "$BASE_DIR" ]; then
  echo "Error: could not find base directory containing .mvn"
  exit 1
fi

MAVEN_OPTS="$(cat "$BASE_DIR/.mvn/jvm.config" 2>/dev/null | tr '\n' ' ') $MAVEN_OPTS"

WRAPPER_JAR="$BASE_DIR/.mvn/wrapper/maven-wrapper.jar"

if [ ! -f "$WRAPPER_JAR" ]; then
  echo "Error: maven-wrapper.jar not found at $WRAPPER_JAR"
  exit 1
fi

exec "$JAVACMD" $MAVEN_OPTS -classpath "$WRAPPER_JAR" \
  -Dmaven.home="${M2_HOME}" \
  -Dmaven.multiModuleProjectDirectory="${BASE_DIR}" \
  org.apache.maven.wrapper.MavenWrapperMain "$@"
